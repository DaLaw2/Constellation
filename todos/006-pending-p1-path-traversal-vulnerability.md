---
status: completed
priority: p1
issue_id: "006"
tags: [code-review, security, filesystem, critical]
dependencies: []
completed_at: 2026-01-19
---

# Path Traversal Vulnerability in Filesystem Commands

## Problem Statement

The filesystem commands in `src/commands/filesystem.rs` have **NO path validation**, allowing arbitrary file system access. An attacker could read sensitive files (system configuration, credentials) or trigger unintended file operations outside the intended directory scope.

**Why this matters:**
- **CVSS Score: 9.1 (CRITICAL)**
- Allows reading ANY file on the system: `C:\Windows\System32\config\SAM`, `C:\Users\*\AppData\...`
- Bypasses intended access controls
- Path validation module exists (commit `e2fe303` on `fix/path-traversal-vulnerability` branch) but was never merged

## Findings

### Source: Security-Sentinel Agent

**Affected Functions:**
- `read_directory()` - Line 163
- `get_file_metadata()` - Line 273
- `open_file_external()` - Line 315
- `reveal_in_explorer()` - Line 332

**Attack Example:**
```javascript
// Frontend can request ANY path
await invoke('read_directory', { path: 'C:\\Windows\\System32\\config' })
await invoke('open_file_external', { path: 'C:\\malware.exe' })
await invoke('get_file_metadata', { path: 'C:\\Users\\Admin\\.ssh\\id_rsa' })
```

**Current Implementation** (read_directory, line 163):
```rust
pub async fn read_directory(path: String) -> AppResult<Vec<FileEntry>> {
    let path_buf = PathBuf::from(&path);  // No validation!

    if !path_buf.exists() {
        return Err(AppError::InvalidInput(format!("Path does not exist: {}", path)));
    }
    // ... proceeds to read ANY directory
}
```

### Evidence

- ❌ No path canonicalization to prevent `..` traversal
- ❌ No whitelist of allowed directories
- ❌ No check against escaping base directory
- ❌ Direct use of user-supplied path without sanitization
- ✅ Path validation module exists in commit `e2fe303` but not merged into this branch

**Related Commit:**
- Branch: `fix/path-traversal-vulnerability`
- Commit: `e2fe303`
- Status: **NOT MERGED** into `feat/phase1.3-file-browser`

## Proposed Solutions

### Solution 1: Merge Existing Path Validation (RECOMMENDED)

**Approach:** Merge the path validation module from `fix/path-traversal-vulnerability` branch.

**Pros:**
- ✅ Already implemented and tested
- ✅ Comprehensive validation logic
- ✅ Fast to deploy (merge + test)

**Cons:**
- ⚠️ Need to verify compatibility with current branch
- ⚠️ May have merge conflicts

**Effort:** 2 hours (merge + test)
**Risk:** Low (existing code)

**Implementation:**
```bash
git checkout feat/phase1.3-file-browser
git merge fix/path-traversal-vulnerability
# Resolve any conflicts
cargo test
```

### Solution 2: Implement Path Validation from Scratch

**Approach:** Create new path validation module with allowlist and canonicalization.

**Implementation:**
```rust
// src/security/path_validator.rs (NEW)
use std::path::{Path, PathBuf};

pub struct PathValidator {
    allowed_roots: Vec<PathBuf>,
}

impl PathValidator {
    pub fn validate(&self, path: &Path) -> AppResult<PathBuf> {
        // 1. Canonicalize to resolve .. and symlinks
        let canonical = path.canonicalize()
            .map_err(|e| AppError::InvalidInput(format!("Invalid path: {}", e)))?;

        // 2. Check against allowed roots
        let is_allowed = self.allowed_roots.iter()
            .any(|root| canonical.starts_with(root));

        if !is_allowed {
            return Err(AppError::AccessDenied(
                "Path outside allowed directories".to_string()
            ));
        }

        Ok(canonical)
    }
}

// Usage in filesystem.rs
pub async fn read_directory(path: String) -> AppResult<Vec<FileEntry>> {
    let validator = PathValidator::new();  // Initialize with user home, drives
    let safe_path = validator.validate(&PathBuf::from(&path))?;

    // Now use safe_path instead of path
    match fs::read_dir(&safe_path) { ... }
}
```

**Pros:**
- ✅ Full control over validation logic
- ✅ Can tailor to specific requirements
- ✅ Fresh implementation, no technical debt

**Cons:**
- ❌ More work than merging existing solution
- ❌ Need comprehensive testing
- ❌ Potential for bugs in new code

**Effort:** 6 hours (implement + test)
**Risk:** Medium (new code, needs testing)

### Solution 3: Minimal Fix - Reject Suspicious Paths

**Approach:** Add simple checks to reject obviously malicious paths.

**Implementation:**
```rust
fn validate_path_basic(path: &str) -> AppResult<()> {
    // Reject paths with suspicious patterns
    if path.contains("..") {
        return Err(AppError::InvalidInput("Path traversal not allowed".into()));
    }

    // Reject system directories
    let forbidden = ["\\Windows\\System32", "\\Program Files", "\\.ssh"];
    if forbidden.iter().any(|f| path.contains(f)) {
        return Err(AppError::AccessDenied("System directory access denied".into()));
    }

    Ok(())
}
```

**Pros:**
- ✅ Quick to implement (30 minutes)
- ✅ Stops obvious attacks

**Cons:**
- ❌ Incomplete protection (easily bypassed)
- ❌ Not a robust solution
- ❌ False positives (legitimate Windows paths rejected)

**Effort:** 30 minutes
**Risk:** High (incomplete fix, false sense of security)

## Recommended Action

**Use Solution 1: Merge existing path validation module**

**Rationale:**
- Code already exists and was tested
- Fastest path to production
- Most reliable (proven implementation)
- Can refine later if needed

**Implementation Steps:**
1. Checkout current branch: `git checkout feat/phase1.3-file-browser`
2. Merge validation branch: `git merge fix/path-traversal-vulnerability`
3. Resolve conflicts (if any)
4. Run tests: `cargo test`
5. Manual security testing:
   - Try accessing `C:\Windows\System32\config` → should be denied
   - Try using `..` in paths → should be denied
   - Verify normal operations still work (browse user directories)
6. Update documentation with allowed directories

## Technical Details

**Affected Files:**
- `src/commands/filesystem.rs` (Lines 163, 273, 315, 332)
- Need new: `src/security/path_validator.rs` (or merge from existing branch)

**Security Considerations:**
- Use `Path::canonicalize()` to resolve symlinks and `..`
- Maintain whitelist of allowed root directories (user home, drives)
- Log all path validation failures for security monitoring
- Consider per-user path restrictions

**Testing Requirements:**
- Unit tests for path validation logic
- Integration tests for filesystem commands with malicious inputs
- Penetration testing: attempt to read system files

## Acceptance Criteria

- [ ] Path validation module integrated into `src/commands/filesystem.rs`
- [ ] All filesystem commands use validated paths
- [ ] Attempting to access `C:\Windows\System32` returns `AccessDenied` error
- [ ] Paths with `..` are rejected or canonicalized safely
- [ ] Normal file browsing (user directories, drives) works correctly
- [ ] Unit tests for path validation cover edge cases
- [ ] Security testing confirms no bypass possible

## Work Log

### 2026-01-19 - Issue Discovered
- Security-Sentinel agent identified critical path traversal vulnerability
- CVSS Score: 9.1 (CRITICAL)
- Found existing fix in commit `e2fe303` on `fix/path-traversal-vulnerability` branch
- **Blocker:** This must be fixed before PR merge

## Resources

- **Related Branch:** `fix/path-traversal-vulnerability` (commit `e2fe303`)
- **Similar Issue:** Path validation in tag management (none - this is unique)
- **OWASP Reference:** [A01:2021 – Broken Access Control](https://owasp.org/Top10/A01_2021-Broken_Access_Control/)
- **Rust Security:** [Prevent Path Traversal](https://rust-lang-nursery.github.io/rust-cookbook/os/dir.html)
