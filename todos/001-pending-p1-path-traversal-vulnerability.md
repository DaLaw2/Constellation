---
status: completed
priority: p1
issue_id: "001"
tags: [code-review, security, critical]
dependencies: []
completed_at: 2026-01-19
---

# Path Traversal Vulnerability - CRITICAL

## Problem Statement

The `Item` model accepts arbitrary file paths without validation or sanitization. This allows potential directory traversal attacks using paths like `../../etc/passwd` or manipulation of critical system files. The vulnerability exists in `create_item` and `update_item` commands.

**Why it matters**: Attackers could access/modify system files, causing data exfiltration, privilege escalation, or system compromise.

## Findings

**Security Sentinel Agent Report:**
- **Severity**: CRITICAL
- **Files Affected**:
  - `src/commands/items.rs` (lines 8-33, 68-102, 105-156)
  - `src/db/models.rs` (lines 23-33)

**Vulnerable Code**:
```rust
// src/commands/items.rs:15-18
let path = path.trim().to_string();
if path.is_empty() {
    return Err(AppError::InvalidInput("Path cannot be empty".to_string()));
}
```

**Attack Scenarios**:
1. Attacker invokes `create_item` with path: `../../../../Windows/System32/critical.dll`
2. Path is stored in database without validation
3. Future file operations using this path could access/modify system files

## Proposed Solutions

### Solution 1: Path Canonicalization with Allowed Root (Recommended)
**Effort**: Medium | **Risk**: Low | **Impact**: High

```rust
use std::path::{Path, PathBuf};

fn validate_and_canonicalize_path(path: &str) -> AppResult<PathBuf> {
    let path = Path::new(path.trim());

    // Reject paths with traversal attempts
    if path.components().any(|c| matches!(c, std::path::Component::ParentDir)) {
        return Err(AppError::InvalidInput("Path traversal detected".to_string()));
    }

    // Canonicalize to resolve symbolic links and relative paths
    let canonical = path.canonicalize()
        .map_err(|_| AppError::InvalidInput("Invalid path".to_string()))?;

    // Enforce that paths must be within allowed directories
    let allowed_root = get_app_allowed_root()?;
    if !canonical.starts_with(&allowed_root) {
        return Err(AppError::InvalidInput("Path outside allowed directory".to_string()));
    }

    Ok(canonical)
}
```

**Pros**:
- Comprehensive protection against all path traversal attacks
- Handles symbolic links and relative paths
- Enforces security boundary

**Cons**:
- Requires defining allowed root directories
- More complex implementation

### Solution 2: Simple Pattern Rejection
**Effort**: Low | **Risk**: Medium | **Impact**: Medium

```rust
fn validate_path_simple(path: &str) -> AppResult<String> {
    let path = path.trim();

    if path.contains("..") || path.contains('\0') {
        return Err(AppError::InvalidInput("Invalid path characters".to_string()));
    }

    Ok(path.to_string())
}
```

**Pros**: Easy to implement
**Cons**: May miss edge cases, doesn't handle symbolic links

### Solution 3: Whitelist Allowed Characters Only
**Effort**: Low | **Risk**: Low | **Impact**: Medium

**Pros**: Simple and secure
**Cons**: May be too restrictive for legitimate use cases

## Recommended Action

**Implement Solution 1** (Path Canonicalization with Allowed Root)

This provides the most comprehensive protection and handles all edge cases including symbolic links, relative paths, and ensures paths stay within app boundaries.

## Technical Details

**Affected Commands**:
- `create_item(path, is_directory, size, modified_time)` - line 8
- `update_item(id, path, size, modified_time)` - line 105
- `get_item_by_path(path)` - line 68

**Files to Modify**:
- Create new validation module: `src/validation/path.rs`
- Update `src/commands/items.rs` to use validation before DB operations
- Add `get_app_allowed_root()` function to `src/state.rs` or config

## Acceptance Criteria

- [ ] All path inputs are validated before database storage
- [ ] Path traversal attempts (../, ../../, etc.) are rejected with clear error
- [ ] Symbolic links are resolved and validated
- [ ] Paths outside allowed directories are rejected
- [ ] Unit tests cover attack scenarios
- [ ] Integration tests verify end-to-end validation

## Work Log

### 2026-01-19
- **Discovered**: Security Sentinel agent identified during code review
- **Status**: Awaiting triage and implementation

## Resources

- Security Sentinel Report: Full audit in agent output
- OWASP Path Traversal: https://owasp.org/www-community/attacks/Path_Traversal
- Related Finding: #019 (Input Validation Insufficient)
